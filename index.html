<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Javascript Calculator</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <div class="calculator" id="calculator"></div>
  <script type="text/babel">
    class GetButton extends React.Component {
      constructor(props) {
        super(props);
        this.handleClick = this.handleClick.bind(this);
      }

      handleClick(e) {
        this.props.onButtonClick(e.target.dataset.value);
      }

      render() {
        return (
          <button 
            className={`cell ${this.props.class}`} 
            id={this.props.id} 
            onClick={this.handleClick} 
            data-value={this.props.value}>{this.props.value}</button>
        );
      }
    }

    class Calculator extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          output: '0',
          formula: '',
          limit: false,
          limitMaxDisplay: 22,
          limitTimeoutId: 0,
          limitTimeoutDisplay: 1500,
          limitText: 'DIGIT LIMIT MET'
        }

        this.handleClearClick = this.handleClearClick.bind(this);
        this.handleNumberClick = this.handleNumberClick.bind(this);
        this.handleDecimalClick = this.handleDecimalClick.bind(this);
        this.handleSubtractClick = this.handleSubtractClick.bind(this);
        this.handleEqualsClick = this.handleEqualsClick.bind(this);
      }

      handleClearClick() {
        clearTimeout(this.state.limitTimeoutId);
        this.setState({
          output: '0',
          formula: '',
          limit: false,
          limitTimeoutId: 0
        });
      }

      handleNumberClick(value) {
        this.setState(state => {
          const result = {
            output: /^0(?!\.)/.test(state.output) ? value : state.output + value,
          }

          if (this.state.limit) {
            result.output = state.limitText;
          } else {
            result.formula = result.output;
          }

          if (result.output.length === state.limitMaxDisplay) {
            result.formula = result.output;
            result.output = state.limitText;
            result.limit = true;
          }

          return result;
        }, () => {
          if (!this.state.limit) {
            return;
          }

          clearTimeout(this.state.limitTimeoutId);
          const id = setTimeout(() => {
            this.setState({
              output: this.state.formula
            });
          }, this.state.limitTimeoutDisplay);
          
          this.setState({ limitTimeoutId: id });
        });
      }

      handleDecimalClick(value) {
        this.setState(state => {
          const result = /\.(?!\.)/.test(state.output) ? state.output : state.output + value;
          return {
            output: result,
            formula: result
          }
        });
      }

      handleSubtractClick(value) {
        this.setState(state => {
          const result = /\d+/.test(state.formula) ? state.formula + value : value;
          return {
            output: result,
            formula: result
          }
        });
      }

      handleEqualsClick() {
        this.setState(state => {
          return {
            output: eval(state.output)
          }
        });
      }

      render() {
        const divideMulti = [{ class: 'sign', id: 'divide', value: '/' }, { class: 'sign', id: 'multiply', value: '*' }];
        const eightNine = [{ id: 'eight', value: '8' }, { id:'nine', value: '9' }];
        const fourToSix = [{ id: 'four', value: '4' }, { id:'five', value: '5' }, { id: 'six', value: '6'}];
        const oneToThree = [{ id: 'one', value: '1' }, { id:'two', value: '2' }, { id: 'three', value: '3'}];

        return (
          <React.Fragment>
            <div className="formula-screen">{this.state.formula}</div>
            <div className="output-screen" id="display">{this.state.output}</div>
            <GetButton id="clear" class="clear" value="AC" onButtonClick={this.handleClearClick} />
            {divideMulti.map((o, i) => <GetButton id={o.id} key={i} class={o.class} value={o.value} onButtonClick={this.handleSubtractClick} />)}
            <GetButton id="seven" value="7" onButtonClick={this.handleNumberClick} />
            {eightNine.map((o, i) => <GetButton id={o.id} key={i} value={o.value} onButtonClick={this.handleNumberClick} />)}
            <GetButton id="subtract" class="sign" value="-" onButtonClick={this.handleSubtractClick} />
            {fourToSix.map((o, i) => <GetButton id={o.id} key={i} value={o.value} onButtonClick={this.handleNumberClick} />)}
            <GetButton id="add" class="sign" value="+" onButtonClick={this.handleSubtractClick} />
            {oneToThree.map((o, i) => <GetButton id={o.id} key={i} value={o.value} onButtonClick={this.handleNumberClick} />)}
            <GetButton id="equals" class="equals" value="=" onButtonClick={this.handleEqualsClick} />
            <GetButton id="zero" class="zero" value="0" onButtonClick={this.handleNumberClick} />
            <GetButton id="decimal" class="decimal" onButtonClick={this.handleDecimalClick} value="." />
          </React.Fragment>
        )
      }
    }

    const root = ReactDOM.createRoot(document.getElementById('calculator'));
    root.render(<Calculator />);
  </script>
</body>
</html>